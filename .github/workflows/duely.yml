name: Duely
on:
  pull_request:
    paths:
      - Duely/**
defaults:
  run:
    shell: bash
    working-directory: Duely
jobs:
  Test:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET 8.0.x
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
          dotnet-quality: ga
      - name: Run tests with code coverage
        run: dotnet test --configuration Release --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
      - name: Create reports directory outside working directory
        run: mkdir -p ../reports
      - name: ReportGenerator
        uses: danielpalme/ReportGenerator-GitHub-Action@5.5.1
        with:
          reports: tests/**/TestResults/**/*.cobertura.xml  # Относительно working-directory
          targetdir: ../reports
          reporttypes: MarkdownSummaryGithub;HtmlInline;Cobertura;Html
          verbosity: Info
          toolpath: reportgeneratortool
      - name: Upload coverage report artifact reports
        uses: actions/upload-artifact@v4
        with:
          name: CoverageReport
          path: ../reports
      - name: Add comment with coverage to PR
        if: github.event_name == 'pull_request'
        run: |
          # Всегда поднимаемся на уровень выше для работы с reports
          cd ..
          
          if [ -f "reports/SummaryGithub.md" ]; then
            echo "Found report at reports/SummaryGithub.md"
            gh pr comment $PR_NUMBER --body-file reports/SummaryGithub.md
          else
            echo "Report file not found. Looking for SummaryGithub.md in:"
            find . -name "SummaryGithub.md" -type f 2>/dev/null
            gh pr comment $PR_NUMBER --body "Code coverage report file was not generated."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
      - name: Publish coverage in build summary
        run: |
          # Поднимаемся на уровень выше для доступа к reports
          cd ..
          
          if [ -f "reports/SummaryGithub.md" ]; then
            cat reports/SummaryGithub.md >> $GITHUB_STEP_SUMMARY
          else
            echo "## Code Coverage" >> $GITHUB_STEP_SUMMARY
            echo "Report file not found" >> $GITHUB_STEP_SUMMARY
          fi