name: Duely
on:
  pull_request:
    paths:
      - Duely/**
defaults:
  run:
    shell: bash
    working-directory: Duely
jobs:
  Test:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET 8.0.x
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
          dotnet-quality: ga
      - name: Run tests with code coverage
        run: dotnet test --configuration Release --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: Duely/tests/**/TestResults/**/*.cobertura.xml
      - name: Generate report file
        run: mkdir -p reports
      - name: ReportGenerator
        uses: danielpalme/ReportGenerator-GitHub-Action@5.5.1
        with:
          reports: Duely/tests/**/TestResults/**/*.cobertura.xml
          targetdir: ../reports
          reporttypes: HtmlInline;Cobertura;Html;MarkdownSummaryGithub
          verbosity: Info
          toolpath: reportgeneratortool
      - name: Upload coverage report artifact reports
        uses: actions/upload-artifact@v4
        with:
          name: CoverageReport       
          path: reports
      - name: Add comment with coverage to PR
        if: github.event_name == 'pull_request'
        run: |
          # Проверяем, существует ли файл с отчетом
          if [ -f "reports/SummaryGithub.md" ]; then
            # Читаем содержимое файла
            REPORT_CONTENT=$(cat reports/SummaryGithub.md)
          
            # Проверяем, не пустой ли отчет
            if [ -n "$REPORT_CONTENT" ]; then
              # Создаем комментарий с отчетом
              echo "$REPORT_CONTENT" > report_content.md
              gh pr comment $PR_NUMBER --body-file report_content.md
            else
              echo "Report file is empty"
              gh pr comment $PR_NUMBER --body "Code coverage report could not be generated."
            fi
          else
            echo "Report file not found"
            gh pr comment $PR_NUMBER --body "Code coverage report file was not generated."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
      - name: Publish coverage in build summary
        run: |
          if [ -f "reports/SummaryGithub.md" ]; then
            cat reports/SummaryGithub.md >> $GITHUB_STEP_SUMMARY
          else
            echo "## Code Coverage" >> $GITHUB_STEP_SUMMARY
            echo "Report file not found" >> $GITHUB_STEP_SUMMARY
          fi